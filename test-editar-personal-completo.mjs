import { chromium } from 'playwright';

async function testEditarPersonalCompleto() {
    console.log('üéØ VERIFICACI√ìN COMPLETA: Funcionalidad editar personal');

    const browser = await chromium.launch({
        headless: false,
        slowMo: 1000
    });

    try {
        const context = await browser.newContext();
        const page = await context.newPage();

        console.log('üì± Navegando al login...');
        await page.goto('http://127.0.0.1:8080/login');
        await page.waitForLoadState('networkidle');

        console.log('üîê Realizando login...');
        await page.fill('input[name="email"]', 'admin@petrotekno.com');
        await page.fill('input[name="password"]', 'password123');
        await page.click('button[type="submit"]');
        await page.waitForLoadState('networkidle');

        // Verificar que el login fue exitoso
        const currentUrl = page.url();
        if (currentUrl.includes('/login')) {
            throw new Error('El login fall√≥ - a√∫n estamos en la p√°gina de login');
        }
        console.log('‚úÖ Login exitoso');

        console.log('üë• Navegando a lista de personal...');
        await page.goto('http://127.0.0.1:8080/personal');
        await page.waitForLoadState('networkidle');

        console.log('‚úèÔ∏è Buscando y haciendo clic en bot√≥n de editar...');
        // Buscar cualquier enlace que contenga "edit" en la URL
        const editLinks = await page.locator('a[href*="/edit"]').all();
        console.log(`üìã Encontrados ${editLinks.length} enlaces de edici√≥n`);

        if (editLinks.length === 0) {
            // Si no hay enlaces de edici√≥n, buscar botones que contengan "editar"
            const editButtons = await page.locator('button:has-text("Editar"), a:has-text("Editar")').all();
            console.log(`üìã Encontrados ${editButtons.length} botones de edici√≥n`);

            if (editButtons.length === 0) {
                throw new Error('No se encontraron botones o enlaces de edici√≥n');
            }
            await editButtons[0].click();
        } else {
            await editLinks[0].click();
        }

        await page.waitForLoadState('networkidle');

        console.log('üîç Verificando que estamos en p√°gina de edici√≥n...');
        const editUrl = page.url();
        console.log(`üìç URL actual: ${editUrl}`);

        if (!editUrl.includes('/edit')) {
            throw new Error('No estamos en la p√°gina de edici√≥n');
        }

        console.log('üìÑ Verificando elementos del formulario...');

        // Verificar campos b√°sicos del formulario
        const nombreField = page.locator('input[name="nombre"]');
        const apellidoField = page.locator('input[name="apellido"]');

        const nombreExists = await nombreField.count() > 0;
        const apellidoExists = await apellidoField.count() > 0;

        console.log(`üìù Campo nombre existe: ${nombreExists}`);
        console.log(`üìù Campo apellido existe: ${apellidoExists}`);

        if (!nombreExists || !apellidoExists) {
            throw new Error('Faltan campos b√°sicos del formulario');
        }

        console.log('‚òëÔ∏è Buscando checkbox "Crear Usuario"...');
        const crearUsuarioCheckbox = page.locator('input[type="checkbox"][x-model="crearUsuario"], input#crear_usuario');

        const checkboxExists = await crearUsuarioCheckbox.count() > 0;
        console.log(`‚òëÔ∏è Checkbox "Crear Usuario" existe: ${checkboxExists}`);

        if (checkboxExists) {
            console.log('‚úÖ Activando checkbox "Crear Usuario"...');
            await crearUsuarioCheckbox.check();

            // Esperar a que aparezcan los campos de usuario
            await page.waitForTimeout(2000);

            console.log('üéØ Verificando select de roles...');
            const roleSelect = page.locator('select[name="rol_usuario"]');

            const selectExists = await roleSelect.count() > 0;
            console.log(`üéØ Select de roles existe: ${selectExists}`);

            if (selectExists) {
                const isVisible = await roleSelect.isVisible();
                console.log(`üëÅÔ∏è Select de roles visible: ${isVisible}`);

                if (isVisible) {
                    // Obtener opciones del select
                    const options = await roleSelect.locator('option').allTextContents();
                    console.log('üìù Opciones de roles encontradas:');
                    options.forEach((option, index) => {
                        console.log(`  ${index + 1}. ${option.trim()}`);
                    });

                    // Verificar que contiene los roles esperados
                    const rolesEsperados = ['Admin', 'Supervisor', 'Operador'];
                    const rolesEncontrados = [];

                    for (const rol of rolesEsperados) {
                        const encontrado = options.some(option => option.includes(rol));
                        if (encontrado) {
                            rolesEncontrados.push(rol);
                            console.log(`‚úÖ Rol "${rol}" encontrado`);
                        } else {
                            console.log(`‚ùå Rol "${rol}" NO encontrado`);
                        }
                    }

                    if (rolesEncontrados.length === 3) {
                        console.log('üéØ ¬°PERFECTO! Los 3 roles est√°n disponibles');

                        // Probar seleccionar un rol
                        console.log('üîÑ Probando selecci√≥n de rol Admin...');
                        await roleSelect.selectOption({ label: 'Admin' });

                        const selectedValue = await roleSelect.inputValue();
                        console.log(`‚úÖ Rol seleccionado correctamente. Valor: ${selectedValue}`);

                    } else {
                        console.log(`‚ö†Ô∏è Solo se encontraron ${rolesEncontrados.length} de 3 roles esperados`);
                    }
                } else {
                    console.log('‚ùå El select de roles no es visible');
                }
            } else {
                console.log('‚ùå No se encontr√≥ el select de roles');
            }
        }

        console.log('üìä Verificando otros campos del formulario...');

        // Verificar campo de categor√≠a
        const categoriaSelect = page.locator('select[name="categoria_personal_id"]');
        const categoriaExists = await categoriaSelect.count() > 0;
        console.log(`üìä Select de categor√≠a existe: ${categoriaExists}`);

        // Verificar campo de tel√©fono
        const telefonoField = page.locator('input[name="telefono"]');
        const telefonoExists = await telefonoField.count() > 0;
        console.log(`üìû Campo tel√©fono existe: ${telefonoExists}`);

        // Verificar campo de email
        const emailField = page.locator('input[name="email"]');
        const emailExists = await emailField.count() > 0;
        console.log(`üìß Campo email existe: ${emailExists}`);

        console.log('üíæ Verificando bot√≥n de guardar...');
        const saveButton = page.locator('button[type="submit"], button:has-text("Guardar"), button:has-text("Actualizar")');
        const saveButtonExists = await saveButton.count() > 0;
        console.log(`üíæ Bot√≥n de guardar existe: ${saveButtonExists}`);

        if (saveButtonExists) {
            const isEnabled = await saveButton.isEnabled();
            console.log(`üíæ Bot√≥n de guardar habilitado: ${isEnabled}`);
        }

        console.log('üìù Probando modificaci√≥n de datos...');

        // Modificar el nombre para probar funcionalidad
        const nombreActual = await nombreField.inputValue();
        console.log(`üìù Nombre actual: ${nombreActual}`);

        const nuevoNombre = nombreActual + ' (Editado)';
        await nombreField.fill(nuevoNombre);
        console.log(`üìù Nombre modificado a: ${nuevoNombre}`);

        console.log('\nüéâ RESUMEN DE VERIFICACI√ìN:');
        console.log('‚úÖ Login exitoso');
        console.log('‚úÖ Navegaci√≥n a lista de personal exitosa');
        console.log('‚úÖ Acceso a formulario de edici√≥n exitoso');
        console.log('‚úÖ Campos b√°sicos del formulario presentes');

        if (checkboxExists) {
            console.log('‚úÖ Checkbox "Crear Usuario" funcional');
            if (roleSelect.count() > 0) {
                console.log('‚úÖ Select de roles aparece al activar checkbox');
                if (rolesEncontrados?.length === 3) {
                    console.log('‚úÖ Los 3 roles (Admin, Supervisor, Operador) est√°n disponibles');
                    console.log('‚úÖ Selecci√≥n de roles funcional');
                }
            }
        }

        console.log('‚úÖ Modificaci√≥n de datos funcional');

        if (saveButtonExists) {
            console.log('‚úÖ Bot√≥n de guardar presente');
        }

        // Capturar screenshot final
        await page.screenshot({
            path: 'verificacion-editar-personal-completa.png',
            fullPage: true
        });
        console.log('üì∏ Screenshot guardado: verificacion-editar-personal-completa.png');

        console.log('\nüèÜ VERIFICACI√ìN COMPLETA EXITOSA');
        console.log('‚ú® El formulario de editar personal funciona correctamente');

    } catch (error) {
        console.error('‚ùå ERROR durante la verificaci√≥n:', error.message);

        // Capturar screenshot del error
        try {
            await page.screenshot({
                path: 'error-editar-personal.png',
                fullPage: true
            });
            console.log('üì∏ Screenshot de error guardado: error-editar-personal.png');

            // Informaci√≥n adicional de debug
            console.log('\nüîç INFORMACI√ìN DE DEBUG:');
            const currentUrl = await page.url();
            console.log(`URL actual: ${currentUrl}`);

            const title = await page.title();
            console.log(`T√≠tulo: ${title}`);

        } catch (screenshotError) {
            console.error('Error al capturar screenshot:', screenshotError.message);
        }

        throw error;
    } finally {
        await browser.close();
    }
}

// Ejecutar la verificaci√≥n
testEditarPersonalCompleto()
    .then(() => {
        console.log('\nüéä ¬°VERIFICACI√ìN COMPLETADA CON √âXITO!');
        console.log('üéØ El formulario de editar personal funciona correctamente');
        console.log('‚ú® Todos los elementos est√°n presentes y funcionan como esperado');
        process.exit(0);
    })
    .catch((error) => {
        console.error('\nüí• VERIFICACI√ìN FALLIDA:', error.message);
        console.error('üîß Revisa los logs y screenshots para m√°s detalles');
        process.exit(1);
    });
