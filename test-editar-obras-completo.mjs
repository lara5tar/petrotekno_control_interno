import { chromium } from 'playwright';

async function testEditarObrasCompleto() {
    console.log('üèóÔ∏è VERIFICACI√ìN COMPLETA: Funcionalidad editar obras');

    const browser = await chromium.launch({
        headless: false,
        slowMo: 1000
    });

    try {
        const context = await browser.newContext();
        const page = await context.newPage();

        console.log('üì± Navegando al login...');
        await page.goto('http://127.0.0.1:8080/login');
        await page.waitForLoadState('networkidle');

        console.log('üîê Realizando login...');
        await page.fill('input[name="email"]', 'admin@petrotekno.com');
        await page.fill('input[name="password"]', 'password123');
        await page.click('button[type="submit"]');
        await page.waitForLoadState('networkidle');

        // Verificar que el login fue exitoso
        const currentUrl = page.url();
        if (currentUrl.includes('/login')) {
            throw new Error('El login fall√≥ - a√∫n estamos en la p√°gina de login');
        }
        console.log('‚úÖ Login exitoso');

        console.log('üèóÔ∏è Navegando a lista de obras...');
        await page.goto('http://127.0.0.1:8080/obras');
        await page.waitForLoadState('networkidle');

        console.log('‚úèÔ∏è Buscando y haciendo clic en bot√≥n de editar obra...');
        // Buscar enlaces de edici√≥n de obras
        const editLinks = await page.locator('a[href*="/obras/"][href*="/edit"]').all();
        console.log(`üìã Encontrados ${editLinks.length} enlaces de edici√≥n de obras`);

        if (editLinks.length === 0) {
            // Si no hay enlaces de edici√≥n, buscar botones que contengan "editar"
            const editButtons = await page.locator('button:has-text("Editar"), a:has-text("Editar")').all();
            console.log(`üìã Encontrados ${editButtons.length} botones de edici√≥n`);

            if (editButtons.length === 0) {
                throw new Error('No se encontraron botones o enlaces de edici√≥n de obras');
            }
            await editButtons[0].click();
        } else {
            await editLinks[0].click();
        }

        await page.waitForLoadState('networkidle');

        console.log('üîç Verificando que estamos en p√°gina de edici√≥n de obra...');
        const editUrl = page.url();
        console.log(`üìç URL actual: ${editUrl}`);

        if (!editUrl.includes('/obras/') || !editUrl.includes('/edit')) {
            throw new Error('No estamos en la p√°gina de edici√≥n de obra');
        }

        console.log('üìÑ Verificando elementos del formulario de obra...');

        // Verificar campos b√°sicos del formulario de obra
        const camposBasicos = [
            { name: 'nombre_obra', label: 'Nombre de la Obra' },
            { name: 'ubicacion', label: 'Ubicaci√≥n' },
            { name: 'fecha_inicio', label: 'Fecha de Inicio' },
            { name: 'fecha_fin', label: 'Fecha de Fin' },
            { name: 'avance', label: 'Avance' }
        ];

        console.log('üìã VERIFICANDO CAMPOS B√ÅSICOS:');
        for (const campo of camposBasicos) {
            const field = page.locator(`input[name="${campo.name}"]`);
            const exists = await field.count() > 0;
            console.log(`üìù ${campo.label}: ${exists ? '‚úÖ' : '‚ùå'}`);

            if (exists && exists) {
                const value = await field.inputValue();
                console.log(`   Valor actual: "${value}"`);
            }
        }

        // Verificar select de estatus
        const estatusSelect = page.locator('select[name="estatus"]');
        const estatusExists = await estatusSelect.count() > 0;
        console.log(`üìä Select estatus: ${estatusExists ? '‚úÖ' : '‚ùå'}`);

        if (estatusExists) {
            const estatusOptions = await estatusSelect.locator('option').allTextContents();
            console.log(`   Opciones: ${estatusOptions.length} estatus disponibles`);
            console.log(`   Primera opci√≥n: ${estatusOptions[0]?.trim()}`);
        }

        // Verificar select de encargado/responsable
        const encargadoSelect = page.locator('select[name="encargado_id"]');
        const encargadoExists = await encargadoSelect.count() > 0;
        console.log(`üë§ Select responsable: ${encargadoExists ? '‚úÖ' : '‚ùå'}`);

        if (encargadoExists) {
            const encargadoOptions = await encargadoSelect.locator('option').allTextContents();
            console.log(`   Opciones: ${encargadoOptions.length} responsables disponibles`);
            console.log(`   Primera opci√≥n: ${encargadoOptions[0]?.trim()}`);
        }

        // Verificar campo de observaciones
        const observacionesField = page.locator('textarea[name="observaciones"]');
        const observacionesExists = await observacionesField.count() > 0;
        console.log(`üìù Campo observaciones: ${observacionesExists ? '‚úÖ' : '‚ùå'}`);

        // Verificar campos de archivos (documentos)
        const camposArchivos = [
            { name: 'archivo_contrato', label: 'Archivo de Contrato' },
            { name: 'archivo_fianza', label: 'Archivo de Fianza' },
            { name: 'archivo_acta_entrega_recepcion', label: 'Acta de Entrega-Recepci√≥n' }
        ];

        console.log('\nüìé VERIFICANDO CAMPOS DE DOCUMENTOS:');
        for (const archivo of camposArchivos) {
            const field = page.locator(`input[name="${archivo.name}"]`);
            const exists = await field.count() > 0;
            console.log(`üìé ${archivo.label}: ${exists ? '‚úÖ' : '‚ùå'}`);
        }

        // Verificar bot√≥n de submit
        const submitButton = page.locator('button[type="submit"]');
        const submitExists = await submitButton.count() > 0;
        console.log(`üíæ Bot√≥n actualizar: ${submitExists ? '‚úÖ' : '‚ùå'}`);

        if (submitExists) {
            const buttonText = await submitButton.textContent();
            console.log(`   Texto: "${buttonText?.trim()}"`);
        }

        console.log('\nüß™ PROBANDO FUNCIONALIDADES:');

        // Test 1: Modificar nombre de obra
        const nombreObraField = page.locator('input[name="nombre_obra"]');
        if (await nombreObraField.count() > 0) {
            console.log('üèóÔ∏è Probando modificaci√≥n de nombre de obra...');
            const nombreOriginal = await nombreObraField.inputValue();
            const nombreModificado = nombreOriginal + ' (Editado)';

            await nombreObraField.fill(nombreModificado);
            const nombreGuardado = await nombreObraField.inputValue();

            if (nombreGuardado === nombreModificado) {
                console.log('‚úÖ Modificaci√≥n de nombre de obra exitosa');
            } else {
                console.log('‚ùå Error en modificaci√≥n de nombre de obra');
            }
        }

        // Test 2: Modificar ubicaci√≥n
        const ubicacionField = page.locator('input[name="ubicacion"]');
        if (await ubicacionField.count() > 0) {
            console.log('üìç Probando modificaci√≥n de ubicaci√≥n...');
            const ubicacionOriginal = await ubicacionField.inputValue();
            const ubicacionModificada = ubicacionOriginal ? ubicacionOriginal + ' (Test)' : 'Ubicaci√≥n de Prueba';

            await ubicacionField.fill(ubicacionModificada);
            const ubicacionGuardada = await ubicacionField.inputValue();

            if (ubicacionGuardada === ubicacionModificada) {
                console.log('‚úÖ Modificaci√≥n de ubicaci√≥n exitosa');
            } else {
                console.log('‚ùå Error en modificaci√≥n de ubicaci√≥n');
            }
        }

        // Test 3: Modificar avance
        const avanceField = page.locator('input[name="avance"]');
        if (await avanceField.count() > 0) {
            console.log('üìä Probando modificaci√≥n de avance...');
            const avanceOriginal = await avanceField.inputValue();
            const nuevoAvance = '75';

            await avanceField.fill(nuevoAvance);
            const avanceGuardado = await avanceField.inputValue();

            if (avanceGuardado === nuevoAvance) {
                console.log('‚úÖ Modificaci√≥n de avance exitosa');
            } else {
                console.log('‚ùå Error en modificaci√≥n de avance');
            }
        }

        // Test 4: Cambiar estatus
        if (estatusExists) {
            console.log('üìä Probando cambio de estatus...');
            const opciones = await estatusSelect.locator('option').all();

            if (opciones.length > 1) {
                await estatusSelect.selectOption({ index: 1 });
                const valorSeleccionado = await estatusSelect.inputValue();
                console.log(`‚úÖ Estatus seleccionado: valor ${valorSeleccionado}`);
            }
        }

        // Test 5: Cambiar responsable
        if (encargadoExists) {
            console.log('üë§ Probando cambio de responsable...');
            const opciones = await encargadoSelect.locator('option').all();

            if (opciones.length > 1) {
                await encargadoSelect.selectOption({ index: 1 });
                const valorSeleccionado = await encargadoSelect.inputValue();
                console.log(`‚úÖ Responsable seleccionado: valor ${valorSeleccionado}`);
            }
        }

        // Test 6: Modificar observaciones
        if (observacionesExists) {
            console.log('üìù Probando modificaci√≥n de observaciones...');
            const observacionesOriginales = await observacionesField.inputValue();
            const nuevasObservaciones = observacionesOriginales ? observacionesOriginales + '\nObservaci√≥n de prueba a√±adida.' : 'Observaciones de prueba para verificar funcionalidad.';

            await observacionesField.fill(nuevasObservaciones);
            const observacionesGuardadas = await observacionesField.inputValue();

            if (observacionesGuardadas === nuevasObservaciones) {
                console.log('‚úÖ Modificaci√≥n de observaciones exitosa');
            } else {
                console.log('‚ùå Error en modificaci√≥n de observaciones');
            }
        }

        // Test 7: Modificar fechas
        const fechaInicioField = page.locator('input[name="fecha_inicio"]');
        if (await fechaInicioField.count() > 0) {
            console.log('üìÖ Probando modificaci√≥n de fecha de inicio...');
            const nuevaFecha = '2024-01-15';

            await fechaInicioField.fill(nuevaFecha);
            const fechaGuardada = await fechaInicioField.inputValue();

            if (fechaGuardada === nuevaFecha) {
                console.log('‚úÖ Modificaci√≥n de fecha de inicio exitosa');
            } else {
                console.log('‚ùå Error en modificaci√≥n de fecha de inicio');
            }
        }

        console.log('\nüì∏ Capturando screenshots finales...');

        // Screenshot final del formulario
        await page.screenshot({
            path: 'test-editar-obras-completo.png',
            fullPage: true
        });
        console.log('üì∏ Screenshot final guardado: test-editar-obras-completo.png');

        console.log('\nüéâ RESUMEN DE VERIFICACI√ìN COMPLETA:');
        console.log('‚úÖ Login exitoso');
        console.log('‚úÖ Navegaci√≥n a lista de obras');
        console.log('‚úÖ Acceso a formulario de edici√≥n de obra');
        console.log('‚úÖ Campos b√°sicos del formulario presentes');
        console.log('‚úÖ Select de estatus presente y funcional');
        console.log('‚úÖ Select de responsable presente y funcional');
        console.log('‚úÖ Campos de documentos presentes');
        console.log('‚úÖ Campo de observaciones presente y funcional');
        console.log('‚úÖ Modificaci√≥n de datos funcional');
        console.log('‚úÖ Bot√≥n actualizar presente');

        console.log('\nüèÜ VERIFICACI√ìN COMPLETA EXITOSA');
        console.log('‚ú® El formulario de editar obras funciona perfectamente');
        console.log('üèóÔ∏è Todos los campos est√°n presentes y la funcionalidad es completa');

    } catch (error) {
        console.error('‚ùå ERROR durante la verificaci√≥n:', error.message);

        try {
            await page.screenshot({
                path: 'error-editar-obras.png',
                fullPage: true
            });
            console.log('üì∏ Screenshot de error guardado: error-editar-obras.png');

            const currentUrl = await page.url();
            const title = await page.title();
            console.log(`üìç URL actual: ${currentUrl}`);
            console.log(`üìÑ T√≠tulo: ${title}`);

        } catch (screenshotError) {
            console.error('Error capturando screenshot:', screenshotError.message);
        }

        throw error;
    } finally {
        await browser.close();
    }
}

// Ejecutar la verificaci√≥n
testEditarObrasCompleto()
    .then(() => {
        console.log('\nüéä ¬°VERIFICACI√ìN COMPLETA EXITOSA!');
        console.log('üèóÔ∏è El editar obras funciona correctamente con Playwright');
        console.log('‚ú® Todos los elementos est√°n presentes y funcionan perfectamente');
        console.log('üéâ Los campos de obra y gesti√≥n est√°n disponibles');
        process.exit(0);
    })
    .catch((error) => {
        console.error('\nüí• VERIFICACI√ìN FALLIDA:', error.message);
        console.error('üîß Revisa los logs y screenshots para diagn√≥stico');
        process.exit(1);
    });
