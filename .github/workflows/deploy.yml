name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to ${{ github.event.inputs.environment || 'production' }}
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql
        tools: composer:v2

    - name: ğŸ“¥ Install Composer dependencies
      run: composer install --prefer-dist --no-dev --optimize-autoloader

    - name: ğŸ“‹ Setup environment
      run: |
        echo "APP_ENV=production" >> .env
        echo "APP_DEBUG=false" >> .env
        echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env
        echo "DB_CONNECTION=mysql" >> .env
        echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
        echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env
        echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env
        echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env

    - name: ğŸ§¹ Optimize application
      run: |
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    - name: ğŸ—„ï¸ Run migrations
      run: php artisan migrate --force

    - name: ğŸ“Š Create deployment artifact
      run: |
        tar -czf deployment.tar.gz \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          --exclude='tests' \
          --exclude='storage/logs/*' \
          --exclude='*.md' \
          .

    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: deployment-package
        path: deployment.tar.gz

    - name: ğŸ”” Notify deployment success
      if: success()
      run: |
        echo "âœ… Deployment successful to ${{ github.event.inputs.environment || 'production' }}"
        echo "ğŸ• Deployed at: $(date)"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
